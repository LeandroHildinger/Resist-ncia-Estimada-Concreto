<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise Preditiva de Resistência do Concreto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">Análise Preditiva de Resistência do Concreto</h1>
            <p class="text-sm sm:text-base text-gray-600 mt-2">Estime a resistência característica futura com base nos resultados de ensaio.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 bg-white p-4 sm:p-6 rounded-xl shadow-lg h-96 lg:h-auto">
                <canvas id="resistanceChart"></canvas>
            </div>

            <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg flex flex-col space-y-6">
                
                <div>
                    <h2 class="text-lg font-semibold border-b pb-2 mb-4">Parâmetros</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="fckInput" class="block text-sm font-medium text-gray-700">Resistência de Projeto (fck)</label>
                            <div class="mt-1 flex items-center">
                                <input type="number" id="fckInput" value="25" class="w-full bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <span class="ml-2 text-gray-500">MPa</span>
                            </div>
                        </div>
                        <div>
                            <label for="cementType" class="block text-sm font-medium text-gray-700">Tipo de Cimento (NBR 16697)</label>
                            <select id="cementType" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <option value="0.25">CP II (Composto)</option>
                                <option value="0.20">CP V-ARI (Alta Resistência Inicial)</option>
                                <option value="0.38">CP III / CP IV (Lento)</option>
                                <option value="0.25">CP I (Comum)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex-grow">
                    <h2 class="text-lg font-semibold border-b pb-2 mb-4">Resultados dos Ensaios</h2>
                    <div class="overflow-x-auto max-h-48">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Idade</th>
                                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase">Resistência</th>
                                    <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 uppercase">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody" class="bg-white">
                            </tbody>
                        </table>
                    </div>
                    <button id="addPointBtn" class="mt-4 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out text-sm font-medium">
                        Adicionar Ensaio
                    </button>
                </div>

                <div class="mt-6">
                    <h2 class="text-lg font-semibold border-b pb-2 mb-4">Análise Preditiva</h2>
                    <div id="guidanceBox" class="p-3 mb-4 text-sm rounded-lg"></div>
                    <div class="space-y-4 p-4 bg-indigo-50 rounded-lg">
                        <div>
                            <label for="predictionDays" class="block text-sm font-medium text-indigo-800">Calcular resistência para:</label>
                            <div class="mt-1 flex items-center">
                                <input type="number" id="predictionDays" placeholder="Ex: 28" class="w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                <span class="ml-2 text-gray-500">dias</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-indigo-800">Resistência Característica Estimada</label>
                            <div id="predictedResistance" class="mt-1 text-xl font-bold text-red-700">-- MPa</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center text-xs text-gray-500 py-6 mt-4">
            Desenvolvido por Leandro Hildinger Cavalcanti
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const ctx = document.getElementById('resistanceChart').getContext('2d');
            const fckInput = document.getElementById('fckInput');
            const cementTypeSelect = document.getElementById('cementType');
            const dataTableBody = document.getElementById('dataTableBody');
            const addPointBtn = document.getElementById('addPointBtn');
            const predictionDaysInput = document.getElementById('predictionDays');
            const predictedResistanceDisplay = document.getElementById('predictedResistance');
            const guidanceBox = document.getElementById('guidanceBox');

            let realData = [];
            let resistanceChart;

            const calculateResistance = (fcm, s, t) => {
                if (t <= 0) return 0;
                return fcm * Math.exp(s * (1 - Math.sqrt(28 / t)));
            };

            const generateCurveData = (fcm, s, maxDays = 90) => {
                const data = [{ x: 0, y: 0 }];
                for (let t = 0.2; t < 1; t += 0.2) {
                    data.push({ x: t, y: calculateResistance(fcm, s, t) });
                }
                for (let t = 1; t <= maxDays; t++) {
                    data.push({ x: t, y: calculateResistance(fcm, s, t) });
                }
                return data;
            };
            
            const findBestFitS = (dataPoints, fcm) => {
                if (dataPoints.length <= 1) return null;
                let bestS = null;
                let minError = Infinity;
                for (let s = 0.01; s <= 0.50; s += 0.001) {
                    let currentError = 0;
                    dataPoints.forEach(point => {
                        currentError += Math.pow(point.mpa - calculateResistance(fcm, s, point.days), 2);
                    });
                    if (currentError < minError) {
                        minError = currentError;
                        bestS = s;
                    }
                }
                return bestS;
            };

            const renderTable = () => {
                dataTableBody.innerHTML = '';
                realData.forEach((point, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-2 py-1"><input type="number" value="${point.days}" data-index="${index}" data-prop="days" class="w-full bg-gray-50 border-gray-200 rounded py-1 px-2 text-sm"></td>
                        <td class="px-2 py-1"><input type="number" step="0.1" value="${point.mpa}" data-index="${index}" data-prop="mpa" class="w-full bg-gray-50 border-gray-200 rounded py-1 px-2 text-sm"></td>
                        <td class="px-2 py-1 text-right"><button data-index="${index}" class="remove-btn text-red-600 hover:text-red-900 text-sm">Remover</button></td>
                    `;
                    dataTableBody.appendChild(row);
                });
                document.querySelectorAll('#dataTableBody input').forEach(input => input.addEventListener('change', handleTableInputChange));
                document.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', handleRemovePoint));
            };

            const updatePrediction = (fcm, s, safetyOffset) => {
                const days = parseFloat(predictionDaysInput.value);
                if (!isNaN(days) && days > 0 && s) {
                    const meanResistance = calculateResistance(fcm, s, days);
                    const characteristicResistance = Math.max(0, meanResistance - safetyOffset);
                    predictedResistanceDisplay.innerHTML = `${characteristicResistance.toFixed(2)} MPa`;
                } else {
                    predictedResistanceDisplay.innerHTML = '-- MPa';
                }
            };
            
            const updateGuidance = (analysis) => {
                let message = '';
                let bgColor = 'bg-gray-100';
                let textColor = 'text-gray-800';

                if (analysis.pointsCount === 0) {
                    message = 'Adicione pelo menos um resultado de ensaio para iniciar a análise.';
                } else if (analysis.pointsCount === 1) {
                    message = '<b>Diagnóstico Inicial:</b> A previsão é uma estimativa baseada no cimento selecionado. Adicione mais pontos para uma análise ajustada.';
                    bgColor = 'bg-blue-100';
                    textColor = 'text-blue-800';
                    
                    const point = realData[0];
                    const theoreticalResistance = calculateResistance(analysis.fcm_base, analysis.s_normative, point.days);
                    const lowerBound = theoreticalResistance * 0.8; // 80% do esperado
                    
                    if (point.mpa < lowerBound) {
                        message += `<br><br><b>Atenção:</b> A resistência aos ${point.days} dias está significativamente abaixo do esperado para este tipo de cimento. Verifique o traço ou as condições de cura.`;
                        bgColor = 'bg-yellow-100';
                        textColor = 'text-yellow-800';
                    }
                } else {
                    message = '<b>Análise Ajustada:</b> A curva foi otimizada com base nos seus dados de ensaio para maior precisão.';
                    bgColor = 'bg-green-100';
                    textColor = 'text-green-800';
                }
                
                guidanceBox.className = `p-3 mb-4 text-sm rounded-lg ${bgColor} ${textColor}`;
                guidanceBox.innerHTML = message;
            };

            const updateApp = () => {
                const fck = parseFloat(fckInput.value) || 0;
                const fcm_base = fck + 8;
                const s_normative = parseFloat(cementTypeSelect.value);

                let s_final = s_normative;
                let fcm_final = fcm_base;
                let safetyOffset = 0;

                if (realData.length === 1) {
                    const point = realData[0];
                    if (point.days > 0 && point.mpa > 0) {
                        fcm_final = point.mpa / Math.exp(s_normative * (1 - Math.sqrt(28 / point.days)));
                        safetyOffset = fcm_final - (fcm_final - 1.65 * 4); // Simula fck a partir do fcm estimado
                        safetyOffset = Math.max(0, fcm_final - (point.mpa / (calculateResistance(fcm_base, s_normative, point.days) / fcm_base)));
                    }
                } else if (realData.length > 1) {
                    s_final = findBestFitS(realData, fcm_base) || s_normative;
                    let maxDifference = 0;
                    realData.forEach(point => {
                        const meanPrediction = calculateResistance(fcm_base, s_final, point.days);
                        const difference = meanPrediction - point.mpa;
                        if (difference > maxDifference) {
                            maxDifference = difference;
                        }
                    });
                    safetyOffset = maxDifference;
                }
                
                const theoreticalCurve = generateCurveData(fcm_base, s_normative);
                const characteristicCurve = generateCurveData(fcm_final, s_final).map(p => ({ x: p.x, y: Math.max(0, p.y - safetyOffset) }));
                
                resistanceChart.data.datasets[0].data = theoreticalCurve.map(p => ({x: p.x, y: p.y.toFixed(2)}));
                resistanceChart.data.datasets[0].label = `Referência (${cementTypeSelect.options[cementTypeSelect.selectedIndex].text})`;
                resistanceChart.data.datasets[1].data = characteristicCurve.map(p => ({x: p.x, y: p.y.toFixed(2)}));
                resistanceChart.data.datasets[2].data = realData.map(p => ({ x: p.days, y: p.mpa }));
                
                resistanceChart.options.plugins.annotation.annotations.fckLine.value = fck;
                resistanceChart.options.plugins.annotation.annotations.fckLine.label.content = `fck = ${fck} MPa`;
                
                resistanceChart.update();
                updatePrediction(fcm_final, s_final, safetyOffset);
                updateGuidance({ pointsCount: realData.length, fcm_base, s_normative });
            };

            const handleTableInputChange = (e) => {
                realData[e.target.dataset.index][e.target.dataset.prop] = parseFloat(e.target.value);
                updateApp();
            };
            const handleRemovePoint = (e) => {
                realData.splice(e.target.dataset.index, 1);
                renderTable();
                updateApp();
            };
            addPointBtn.addEventListener('click', () => {
                realData.push({ days: 3, mpa: 10 });
                renderTable();
                updateApp();
            });
            [fckInput, cementTypeSelect].forEach(el => el.addEventListener('change', updateApp));
            predictionDaysInput.addEventListener('input', () => {
                const fck = parseFloat(fckInput.value) || 0;
                const fcm_base = fck + 8;
                const s_normative = parseFloat(cementTypeSelect.value);

                let s_final = s_normative;
                let fcm_final = fcm_base;
                let safetyOffset = 0;

                 if (realData.length === 1) {
                    const point = realData[0];
                    if (point.days > 0 && point.mpa > 0) {
                        fcm_final = point.mpa / Math.exp(s_normative * (1 - Math.sqrt(28 / point.days)));
                        safetyOffset = Math.max(0, fcm_final - (point.mpa / (calculateResistance(fcm_base, s_normative, point.days) / fcm_base)));
                    }
                } else if (realData.length > 1) {
                    s_final = findBestFitS(realData, fcm_base) || s_normative;
                    let maxDifference = 0;
                    realData.forEach(point => {
                        const meanPrediction = calculateResistance(fcm_base, s_final, point.days);
                        const difference = meanPrediction - point.mpa;
                        if (difference > maxDifference) {
                            maxDifference = difference;
                        }
                    });
                    safetyOffset = maxDifference;
                }
                updatePrediction(fcm_final, s_final, safetyOffset);
            });

            const initializeChart = () => {
                resistanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [
                            { label: 'Referência', data: [], borderColor: 'rgba(59, 130, 246, 0.7)', borderWidth: 2, pointRadius: 0, tension: 0.4, fill: false, borderDash: [5, 5], cubicInterpolationMode: 'monotone' },
                            { label: 'Curva Característica Estimada', data: [], borderColor: 'rgba(220, 38, 38, 1)', borderWidth: 3, pointRadius: 0, tension: 0.4, fill: false, cubicInterpolationMode: 'monotone' },
                            { type: 'scatter', label: 'Resultados Reais (Ensaio)', data: [], backgroundColor: 'rgba(239, 68, 68, 1)', borderColor: 'rgba(220, 38, 38, 1)', pointRadius: 6, pointHoverRadius: 8, z: 10 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Idade do Concreto (dias)', font: { size: 12 } } },
                            y: { title: { display: true, text: 'Resistência (MPa)', font: { size: 12 } }, beginAtZero: true }
                        },
                        plugins: {
                            legend: { position: 'bottom', align: 'start', labels: { boxWidth: 20, padding: 15, font: { size: 10 } } },
                            tooltip: {
                                mode: 'x', intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        if (context.parsed.y !== null) { label += parseFloat(context.parsed.y).toFixed(2) + ' MPa'; }
                                        return label;
                                    }
                                }
                            },
                            annotation: {
                                annotations: {
                                    fckLine: { type: 'line', yMin: 0, yMax: 0, borderColor: 'rgba(245, 158, 11, 1)', borderWidth: 2, borderDash: [10, 5], label: { content: '', enabled: true, position: 'end', backgroundColor: 'rgba(245, 158, 11, 0.8)', color: 'white', font: { size: 10 } } }
                                }
                            }
                        }
                    }
                });
                renderTable();
                updateApp();
            };

            initializeChart();
        });
    </script>

</body>
</html>
